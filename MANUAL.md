# PC製造ダッシュボードシステム 操作マニュアル

## 1. システム概要

このシステムは、2つの主要なプログラムで構成されています。

1.  **データ処理バックエンド (`main.py`)**:
    -   生産実績データ(`KANSEI_JISSEKI.txt`)を定期的（1時間ごと）に読み込み、データベースを更新する裏方のプログラムです。
    -   常時稼働させることを想定しています。

2.  **ダッシュボードUI (`app.py`)**:
    -   バックエンドが更新したデータベースの情報を、グラフや表で可視化するWebアプリケーションです。
    -   ユーザーがデータを見たいときに起動します。

## 2. アーキテクチャ

この2つのプログラムは、`data/sqlite/production.db` というデータベースファイルを介して連携します。

```
[KANSEI_JISSEKI.txt] ----(1時間ごと)----> [main.py] ----(書き込み)----> [production.db] <----(読み込み)---- [app.py] ----> [Webブラウザ]
```

-   `main.py`は、定期的に実績データをデータベースに書き込み、データを蓄積していきます。
-   `app.py`は、その蓄積されたデータを読み込んで表示するだけです。

この設計により、データ更新処理と画面表示処理が分離され、安定した運用が可能になります。

## 3. 操作手順

### 3.1. データ処理バックエンドの実行

このプログラムは、一度起動したら、PCをシャットダウンするまで動き続ける常駐サービスです。
PC起動時などに、コマンドプロンプトやターミナルで以下のコマンドを一回だけ実行してください。

```bash
python -m src.main
```

実行すると、1時間ごとに`KANSEI_JISSEKI.txt`をチェックし、新しいデータをデータベースに登録し続けます。

### 3.2. ダッシュボードUIの表示

データをグラフや表で確認したい場合は、別のコマンドプロンプトやターミナルを立ち上げ、以下のコマンドを実行します。

```bash
python -m streamlit run src/app.py
```

実行後、ターミナルに表示されるURL（例: `http://localhost:8501`）をWebブラウザで開くと、ダッシュボードが表示されます。

### 3.3. 品目マスターの更新

`\\SAPIF01\host\JOHODBDL\TEIKEI\MASTER\HINMOKU\MARA_DL.csv` の内容を更新した際は、**その都度**、以下の特別なコマンドを実行して、データベースの内容を同期させる必要があります。

これにより、データベース内の品目マスター情報がCSVファイルの最新の状態と完全に一致するように洗い替え（全件上書き）されます。

**注意:** このコマンドは、バックエンドサービス(`main.py`)が動いていない状態で実行するのが安全です。

```bash
python -m src.main --sync-master
```

## 4. 本番環境での実行

本番運用で、ネットワーク上のライブデータを参照して処理を実行する場合は、`--prod` オプションを付けて各コマンドを実行します。

-   **開発環境 (デフォルト)**: `data/sample/` 内のサンプルファイルを参照します。
-   **本番環境 (`--prod`付き)**: `\\SAPIF01\...` から始まるネットワークパス上の実ファイルを参照します。

### 本番用コマンド例

**データ処理バックエンドの起動（本番）:**
```bash
python -m src.main --prod
```

**ダッシュボードUIの起動（本番）:**
```bash
python -m streamlit run src/app.py -- --prod
```
**注意:** Streamlitで引数を渡す際は、`--`が間に入ります。

**品目マスターの同期（本番）:**
```bash
python -m src.main --sync-master --prod
```

### 3.4. 仕掛・在庫データの同期（本番環境）

本番環境で、日次で更新される「仕掛明細」ファイルを含むデータを同期するには、以下の**2ステップ**の操作が必要です。

#### ステップ1: 最新の仕掛明細ファイルパスを取得する

まず、以下のコマンドを実行して、対象となる最新の仕掛明細ファイルのフルパスを調べます。

```bash
python tools/find_latest_wip.py
```

実行すると、以下のようにパスがダブルクォーテーションで囲まれて表示されます。これをコピーしてください。

```
"\\SAPIF01\全社共有\経営企画部　経理課\情ｼｽ在庫ﾃﾞｰﾀ\仕掛品\202508末_仕掛明細表_WBS集約(仕掛年齢付与)_0901.xlsx"
```

#### ステップ2: 取得したパスを使ってデータ同期を実行する

次に、ステップ1でコピーしたパスを `--wip-file` 引数に指定して、同期コマンドを実行します。

```bash
python -m src.main --sync-wip --prod --wip-file "ここにステップ1でコピーしたパスを貼り付け"
```
